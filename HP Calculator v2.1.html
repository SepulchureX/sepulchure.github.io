<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PF1e HP Calculator v2.1</title>
    <style>
        :root {
            --primary: #8b2d2d;
            --parchment: #fdf6e3;
            --parchment-dark: #eee8d5;
            --text: #2c2c2c;
            --border: #d2b48c;
            --highlight: #d4a017;
            --blue-accent: #2d5d8b;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #2c2c2c;
            display: flex;
            justify-content: center;
            padding: 20px;
            margin: 0;
            color: var(--text);
        }

        .calculator-card {
            background-color: var(--parchment);
            width: 100%;
            max-width: 650px;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            border: 4px double var(--border);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background-color: var(--primary);
            color: white;
            padding: 15px;
            text-align: center;
            border-bottom: 4px double var(--highlight);
        }
        .header h1 { margin: 0; font-size: 1.4rem; text-transform: uppercase; letter-spacing: 1px; }

        .section {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
        }

        .section-title {
            font-weight: bold;
            color: var(--primary);
            text-transform: uppercase;
            font-size: 0.85rem;
            margin-bottom: 10px;
            letter-spacing: 0.5px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: bold;
            font-size: 0.85rem;
            margin-bottom: 4px;
            color: #555;
            display: flex;
            justify-content: space-between;
        }

        .mod-display {
            color: var(--primary);
            font-weight: bold;
        }

        input[type="number"], input[type="text"], select {
            padding: 8px;
            border: 1px solid var(--border);
            background: #fff;
            border-radius: 4px;
            font-size: 0.95rem;
        }

        .toggle-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
            cursor: pointer;
            background: rgba(0,0,0,0.05);
            padding: 8px;
            border-radius: 4px;
        }

        /* Mythic Section */
        #mythic-container {
            grid-column: 1 / -1;
            display: none; /* Hidden by default */
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            background-color: rgba(212, 160, 23, 0.1); /* Slight gold tint */
            padding: 15px;
            border-radius: 4px;
            border: 1px dashed var(--highlight);
        }
        
        #mythic-container.visible {
            display: grid;
        }

        /* Class Rows */
        .class-list { padding: 0; }
        .class-row {
            display: grid;
            grid-template-columns: 2fr 1fr 25px;
            gap: 10px;
            padding: 15px 20px;
            background-color: rgba(255,255,255,0.5);
            border-bottom: 1px dashed var(--border);
            align-items: center;
        }
        .class-row:nth-child(even) { background-color: rgba(0,0,0,0.03); }

        .class-controls {
            display: flex;
            gap: 15px;
            font-size: 0.8rem;
            grid-column: 1 / -1;
            margin-top: 5px;
            color: #555;
            flex-wrap: wrap;
        }

        /* Modifiers */
        .mod-row {
            display: grid;
            grid-template-columns: 2fr 1fr 25px;
            gap: 10px;
            margin-bottom: 8px;
            align-items: center;
        }

        /* Buttons */
        .btn {
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
            text-transform: uppercase;
            font-size: 0.8rem;
            border-radius: 4px;
            padding: 8px 12px;
        }

        .btn-add {
            background-color: var(--parchment-dark);
            color: var(--primary);
            width: 100%;
            margin-top: 5px;
            border: 1px solid var(--border);
        }
        .btn-add:hover { background-color: #e0d8c0; }

        .remove-icon {
            color: #a00;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2rem;
            border: none;
            background: none;
            text-align: center;
            line-height: 1;
        }
        .remove-icon:hover { color: #f00; }

        /* Result Area */
        .result-section {
            background-color: #fff;
            padding: 20px;
            text-align: center;
            border-top: 4px double var(--highlight);
            margin-top: auto;
        }

        .total-hp {
            font-size: 3.5rem;
            font-weight: bold;
            color: var(--primary);
            line-height: 1;
        }

        .breakdown {
            font-size: 0.85rem;
            color: #666;
            margin-top: 10px;
            font-family: monospace;
            background: #f4f4f4;
            padding: 8px;
            border-radius: 4px;
        }

        /* Inputs Checkboxes */
        input[type="checkbox"], input[type="radio"] {
            accent-color: var(--primary);
            transform: scale(1.1);
        }
    </style>
</head>
<body>

<div class="calculator-card">
    <div class="header">
        <h1>Pathfinder 1e HP Calculator</h1>
    </div>

    <div class="section settings-grid">
        <div class="input-group">
            <label for="con-score">
                Constitution Score
                <span id="con-mod-display" class="mod-display">(+0)</span>
            </label>
            <input type="number" id="con-score" value="10" min="0" onchange="calculateHP()">
        </div>
        <div class="input-group">
            <label for="avg-mode">Average Mode (Rolled Levels)</label>
            <select id="avg-mode" onchange="calculateHP()">
                <option value="high">Start High (6, 5, 6...)</option>
                <option value="low">Start Low (5, 6, 5...)</option>
            </select>
        </div>
        
        <div class="input-group" style="grid-column: 1 / -1;">
            <label class="toggle-group">
                <input type="checkbox" id="toughness" onchange="calculateHP()">
                <span><strong>Toughness Feat</strong> (+3 HP, then +1/lvl after 3rd)</span>
            </label>
            <label class="toggle-group">
                <input type="checkbox" id="mythic-toggle" onchange="toggleMythic()">
                <span><strong>Mythic Tiers</strong> (Add Mythic Ranks)</span>
            </label>
        </div>

        <div id="mythic-container">
            <div class="input-group">
                <label for="mythic-rank">Mythic Rank (0-12)</label>
                <input type="number" id="mythic-rank" value="1" min="0" max="12" onchange="clampInput(this, 0, 12)">
            </div>
            <div class="input-group">
                <label for="mythic-hp">HP per Rank (Path)</label>
                <input type="number" id="mythic-hp" value="3" min="0" max="12" onchange="clampInput(this, 0, 12)">
            </div>
            <label class="toggle-group" style="grid-column: 1 / -1;">
                <input type="checkbox" id="mythic-toughness" onchange="calculateHP()">
                <span><strong>Mythic Toughness</strong> (Doubles Toughness HP)</span>
            </label>
        </div>
    </div>

    <div class="section">
        <div class="section-title">Class Levels</div>
        <div id="class-container" class="class-list"></div>
        <button class="btn btn-add" onclick="addClass()">+ Add Class</button>
    </div>

    <div class="section">
        <div class="section-title">Custom Modifiers</div>
        <div id="mod-container"></div>
        <button class="btn btn-add" onclick="addModifier()">+ Add Custom Bonus</button>
    </div>

    <div class="result-section">
        <div class="total-hp" id="total-hp">0</div>
        <div>Total Hit Points</div>
        <div class="breakdown" id="hp-breakdown">Calculate to see details...</div>
    </div>
</div>

<script>
    let classes = [];
    let modifiers = [];
    let nextClassId = 0;
    let nextModId = 0;

    window.onload = function() {
        addClass(); // Start with one class
        calculateHP();
    };

    function toggleMythic() {
        const isChecked = document.getElementById('mythic-toggle').checked;
        const container = document.getElementById('mythic-container');
        if (isChecked) {
            container.classList.add('visible');
        } else {
            container.classList.remove('visible');
        }
        calculateHP();
    }

    // Input Clamping Helper
    function clampInput(element, min, max) {
        let val = parseInt(element.value);
        if (isNaN(val)) val = min;
        if (val < min) val = min;
        if (val > max) val = max;
        element.value = val;
        calculateHP();
    }

    // --- Class Logic ---

    function addClass() {
        const id = nextClassId++;
        const newClass = {
            id: id,
            hd: 10,      // default d10 (Fighter standard)
            level: 1,
            isFavored: classes.length === 0, 
            isFirst: classes.length === 0 
        };
        classes.push(newClass);
        renderClasses();
        calculateHP();
    }

    function removeClass(id) {
        if (classes.length <= 1) return; 
        classes = classes.filter(c => c.id !== id);
        
        // Ensure someone is "First" (Character Level 1)
        if (!classes.some(c => c.isFirst)) classes[0].isFirst = true;
        // Ensure someone is "Favored" 
        if (!classes.some(c => c.isFavored)) classes[0].isFavored = true;
        renderClasses();
        calculateHP();
    }

    function updateClass(id, field, value) {
        const idx = classes.findIndex(c => c.id === id);
        if (idx === -1) return;

        if (field === 'isFirst') {
            classes.forEach(c => c.isFirst = false);
            classes[idx].isFirst = true;
        } else if (field === 'isFavored') {
            classes.forEach(c => c.isFavored = false);
            classes[idx].isFavored = true;
        } else {
            classes[idx][field] = parseInt(value);
        }
        
        renderClasses(); 
        calculateHP();
    }

    function renderClasses() {
        const container = document.getElementById('class-container');
        container.innerHTML = '';

        classes.forEach((c) => {
            const html = `
                <div class="class-row">
                    <div class="input-group">
                        <label>Hit Die (d${c.hd})</label>
                        <select onchange="updateClass(${c.id}, 'hd', this.value)">
                            <option value="6" ${c.hd === 6 ? 'selected' : ''}>d6 (Wiz/Sorc)</option>
                            <option value="8" ${c.hd === 8 ? 'selected' : ''}>d8 (Clr/Rog/Drd)</option>
                            <option value="10" ${c.hd === 10 ? 'selected' : ''}>d10 (Ftr/Pal/Rgr)</option>
                            <option value="12" ${c.hd === 12 ? 'selected' : ''}>d12 (Barb)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Levels</label>
                        <input type="number" min="1" value="${c.level}" onchange="updateClass(${c.id}, 'level', this.value)">
                    </div>
                    <button class="remove-icon" onclick="removeClass(${c.id})">&times;</button>
                    
                    <div class="class-controls">
                        <label style="display:flex; align-items:center; gap:5px; cursor:pointer;" title="Level 1 of this class is your character's 1st level (Max HP)">
                            <input type="radio" name="firstGroup" ${c.isFirst ? 'checked' : ''} onchange="updateClass(${c.id}, 'isFirst', true)">
                            <span style="color:${c.isFirst ? 'var(--primary)' : 'inherit'}; font-weight:${c.isFirst ? 'bold' : 'normal'}">Starting Class (Max First HD)</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:5px; cursor:pointer;" title="+1 HP per level">
                            <input type="radio" name="favoredGroup" ${c.isFavored ? 'checked' : ''} onchange="updateClass(${c.id}, 'isFavored', true)">
                            <span style="color:${c.isFavored ? 'var(--primary)' : 'inherit'}; font-weight:${c.isFavored ? 'bold' : 'normal'}">Favored (+1 HP)</span>
                        </label>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    // --- Custom Modifier Logic ---

    function addModifier() {
        const id = nextModId++;
        modifiers.push({ id: id, name: "Misc Bonus", value: 0 });
        renderModifiers();
        calculateHP();
    }

    function removeModifier(id) {
        modifiers = modifiers.filter(m => m.id !== id);
        renderModifiers();
        calculateHP();
    }

    function updateModifier(id, field, value) {
        const idx = modifiers.findIndex(m => m.id === id);
        if (idx === -1) return;
        modifiers[idx][field] = field === 'value' ? parseInt(value) || 0 : value;
        calculateHP();
    }

    function renderModifiers() {
        const container = document.getElementById('mod-container');
        container.innerHTML = '';
        modifiers.forEach(m => {
            const html = `
                <div class="mod-row">
                    <input type="text" value="${m.name}" placeholder="Name" onchange="updateModifier(${m.id}, 'name', this.value)">
                    <input type="number" value="${m.value}" placeholder="0" onchange="updateModifier(${m.id}, 'value', this.value)">
                    <button class="remove-icon" onclick="removeModifier(${m.id})">&times;</button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    // --- Calculation Logic ---

    function calculateHP() {
        // --- CON LOGIC ---
        let rawCon = parseInt(document.getElementById('con-score').value);
        // FIX: '0 || 10' logic prevented Con 0. Now checking isNaN.
        let conScore = isNaN(rawCon) ? 10 : rawCon;
        
        // Ensure negative isn't possible in UI if desired, but 0 is valid.
        // (If the user explicitly types -5, we can allow it or floor it to 0. 
        // Standard rules usually min 0. Let's keep min 0).
        if (conScore < 0) { conScore = 0; document.getElementById('con-score').value = 0; }
        
        // Calculate Modifier: floor((Score - 10) / 2)
        const conMod = Math.floor((conScore - 10) / 2);
        
        // Update display text
        const modSign = conMod >= 0 ? '+' : '';
        document.getElementById('con-mod-display').innerText = `(${modSign}${conMod})`;

        // --- OTHER INPUTS ---
        const avgMode = document.getElementById('avg-mode').value;
        const hasToughness = document.getElementById('toughness').checked;
        const hasMythic = document.getElementById('mythic-toggle').checked;
        const hasMythicToughness = document.getElementById('mythic-toughness').checked;

        let totalHP = 0;
        let totalLevels = 0;
        let breakdownDice = 0;
        let breakdownFavored = 0;
        
        let cumulativeRolledLevels = 0;

        classes.forEach(c => {
            for (let i = 1; i <= c.level; i++) {
                totalLevels++;
                
                const isCharLevel1 = (c.isFirst && i === 1);

                if (isCharLevel1) {
                    totalHP += c.hd;
                    breakdownDice += c.hd;
                } else {
                    cumulativeRolledLevels++; 
                    const lowVal = c.hd / 2; 
                    const highVal = (c.hd / 2) + 1;
                    let useHigh = false;

                    if (avgMode === 'high') {
                        useHigh = (cumulativeRolledLevels % 2 !== 0);
                    } else {
                        useHigh = (cumulativeRolledLevels % 2 === 0);
                    }

                    const val = useHigh ? highVal : lowVal;
                    totalHP += val;
                    breakdownDice += val;
                }
            }

            if (c.isFavored) {
                totalHP += c.level;
                breakdownFavored += c.level;
            }
        });

        // CON Calculation
        const conTotal = conMod * totalLevels;
        totalHP += conTotal;

        // Toughness & Mythic Toughness
        let toughnessHP = 0;
        if (hasToughness) {
            // Standard Toughness: 3 HP for levels 1-3, then +1 per level.
            let baseToughness = totalLevels <= 3 ? 3 : totalLevels;
            
            // Mythic Toughness: Doubles the HP gained from Toughness.
            if (hasMythic && hasMythicToughness) {
                baseToughness *= 2;
            }
            
            toughnessHP = baseToughness;
            totalHP += toughnessHP;
        }

        // Mythic Ranks
        let mythicTotal = 0;
        if (hasMythic) {
            let mRank = parseInt(document.getElementById('mythic-rank').value) || 0;
            let mHP = parseInt(document.getElementById('mythic-hp').value) || 0;

            // Calculation logic
            mythicTotal = mRank * mHP;
            totalHP += mythicTotal;
        }

        // Custom Modifiers
        let modTotal = 0;
        modifiers.forEach(m => modTotal += m.value);
        totalHP += modTotal;

        // UI Update
        document.getElementById('total-hp').innerText = totalHP;

        // Breakdown String
        let parts = [];
        parts.push(`HD: ${breakdownDice}`);
        if (conTotal !== 0) parts.push(`CON: ${conTotal > 0 ? '+' : ''}${conTotal}`);
        if (breakdownFavored > 0) parts.push(`FCB: +${breakdownFavored}`);
        if (toughnessHP > 0) parts.push(`Toughness${hasMythicToughness && hasMythic ? ' (M)' : ''}: +${toughnessHP}`);
        if (mythicTotal > 0) parts.push(`Mythic: +${mythicTotal}`);
        if (modTotal !== 0) parts.push(`Misc: ${modTotal > 0 ? '+' : ''}${modTotal}`);

        document.getElementById('hp-breakdown').innerText = 
            `Lvl ${totalLevels} | ${parts.join(' | ')}`;
    }
</script>

</body>
</html>